<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Propensity Score Analysis (PSA) – Day 1</title>
    <meta charset="utf-8" />
    <meta name="author" content="Chaochen Wang (CWAN)   Thomas Laurent (TLAU)" />
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Propensity Score Analysis (PSA) – Day 1
### Chaochen Wang (CWAN) <br> Thomas Laurent (TLAU)
### 2019-12-13 17:00~18:00 <span class="citation">@CSS</span>

---



class: middle
# Objectives

- Revision about causal inference framework and terminologies.

- Introduction of Propensity Score Analysis (PSA).  

- Understand the **pre-assumptions** that required for PSA.

- How to test for unobserved confounders? &lt;br&gt;(by TLAU)

- Discuss the ways of using Propensity Scores. 

&lt;!-- - Understand that PSA is **not omnipotent** --&gt;

???


---
class: middle, center, inverse

## Some background before PSA


---
class: middle

## What do me mean by &lt;br&gt;"causal inference"? (1)


- Most data analysis in medical research (or in other area) has a central aim - to learn about **cause-effect relationships**. 

    - Does the treatment work? 
    - How harmful is the exposure? 
    - How effective would the policy be and why?
    
    
---
class: middle

## What do me mean by &lt;br&gt;"causal inference"? (2)

- Randomised studies are **randomised** precisely to make causal inference more reliable. 

- When randomisation is not feasible, we still wish to make inferences about effects of causes. 

- However, most medical studies can only be interpreted as *"associations"* rather than causal effect. 


---
class: middle

## Example


Anaemic patients undergoing hip replacement operation might benefit from receiving an **intravenous iron supplement** prior to surgery. 

- Data collected in one hospital on all anaemic patients undergoing a hip replacement operation between 2009 and 2014. 

- `\(X\)`:  **intravenous iron supplement**, yes or no
- `\(Y\)`: 90 days survival after operation, alive or dead

---
class: middle 

### Other data collected in the example: 

- Age, gender, co-morbidities (CVD, diabetes, renal disease);

- Severity of anaemia;

- Operation types;

- Whether or not transfusion needed during operation;

- Length of stay in hospital;

---
class: middle

## Traditional Approach - crude 

- We start by looking at a 2 `\(\times\)` 2 table:


&lt;table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
&lt;tr&gt;
&lt;th style="border-bottom:hidden" colspan="2"&gt;&lt;/th&gt;
&lt;th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2"&gt;&lt;div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; "&gt;Death90&lt;/div&gt;&lt;/th&gt;
&lt;/tr&gt;
  &lt;tr&gt;
   &lt;th style="text-align:center;"&gt;  &lt;/th&gt;
   &lt;th style="text-align:center;"&gt;  &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 0 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:center;font-weight: bold;vertical-align: middle !important;" rowspan="2"&gt; FeIV &lt;/td&gt;
   &lt;td style="text-align:center;font-weight: bold;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 9206 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 376 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   
   &lt;td style="text-align:center;font-weight: bold;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 7365 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 312 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


- Estimated log odds ratio `\(= \log(\frac{312\times9206}{376\times7365}) = 0.04, 95\% \text{CI: } -0.12, 0.19\)` 

---
class: middle
## Traditional Approach - crude 

- What are we estimating here? The **estimand**&lt;sup&gt;1&lt;/sup&gt; is 

$$
`\begin{aligned}
\log\text{OR}_{Y|X} &amp; = \log{\frac{\text{Pr}(Y = 1 | X = 1)}{1- \text{Pr}(Y = 1 | X = 1)}} \\
                    &amp; \;\;\;\;\;\;\;\;\; - \log{\frac{\text{Pr}(Y = 1 | X = 0)}{1- \text{Pr}(Y = 1 | X = 0)}}
\end{aligned}`
$$

.footnote[
[1] **Estimand** is defined as the value that we we would like to know, such as "the mean BMI of the population in Japan". This is an unknown but fixed quantity.
]

---
class: middle

## Confounding

- We cannot give `\(\log\text{OR}_{Y|X}\)` a causal interpretation because there is **confounding**. 
- It is possible that patients provided with intravenous iron were already worse off, masking a truely effect of the exposure. 
- So the estimand changed into a **conditional logOR**: 


$$
`\begin{aligned}
\log\text{OR}_{Y|X} &amp; = \log{\frac{\text{Pr}(Y = 1 | X = 1, \textbf{C})}{1- \text{Pr}(Y = 1 | X = 1, \textbf{C})}} \\
                    &amp; \;\;\;\;\;\;\;\;\; - \log{\frac{\text{Pr}(Y = 1 | X = 0, \textbf{C})}{1- \text{Pr}(Y = 1 | X = 0, \textbf{C})}}
\end{aligned}`
$$

---
class: middle

## Conditioning on covariates


- So we have some statistical variable selection procedure. 
- Transfusion, and length of stay in hospital are on the causal pathway from `\(X\)` to `\(Y\)`, so they were excluded from adjustment.
- After adjustment of the other covariates, we have an estimated conditional logOR of &lt;br&gt; -0.24 (95% CI -0.41, -0.07)
- WE may interpret this logOR as evidence that patients treated with iron supplement before hip replacement surgery had lower odds of dying within 90 days of operation.

---
class: middle, center

## But, the conditional logOR still cannot answer our question: 


--
## What is the survival probability if, 

--
## **contrary to reality**, 

--
## every patient were treated with intravenous iron?


---
class: middle

## Causal languages

1. We ask the question: how `\(Y\)` would react if we could change `\(X\)` and assign it, **contrary to how it was actually assigned.** &lt;br&gt; -- potential outcomes &lt;br&gt;(Neyman, 1923; Rubin, D. 1974)

2. `\(Y(x)\)` is defined as the value that `\(Y\)` would take if `\(X\)` were (hypothetically) set to value of `\(x\)`

3. Causal effect is expressed as comparisons between `\(Y(x)\)`: &lt;br&gt; `\(E\{Y(1)\} - E\{Y(0)\}\)`


---
class: middle

## Potential Causal Estimands - binary outcome

- Marginal causal risk difference:

$$
\text{Pr}[Y(1) = 1] - \text{Pr}[Y(0) = 1]
$$

- Conditional causal log odds ratio:

$$
\log\frac{\text{Pr}(Y(1) = 1, \textbf{C})}{1- \text{Pr}(Y(1) = 1,  \textbf{C})} - \log\frac{\text{Pr}(Y(0) = 1, \textbf{C})}{1- \text{Pr}(Y(0) = 1,  \textbf{C})}
$$


---
class: middle

## Potential Causal Estimands - cont. outcome

- Marginal causal mean difference: 

`$$E\{Y(1) - Y(0)\}$$`
- Conditional causal mean difference:

`$$E\{Y(1) - Y(0)|\mathbf{C}\}$$`

They are called the **Average Causal/Treatment Effect (ACE or ATE)**. 

---
class: middle

## Assumption No 1: **No Interference**

- Potential value of `\(Y_i\)`, does not depend on `\(X_j\)`: 

    - `\(i, j\)`, are individual indices `\(\approx\)` independent

    - we assume that a (hypothetical) exposure for individual `\(j\)`, does not change the outcome of individual `\(i\)`


- An example of violation is in the study of vaccines, where vaccinating individual `\(j\)` may affect the disease status of individual `\(i\)`.


---
class: middle

## Assumption No 2: **Consistency**

$$
X_i = x \Rightarrow Y_i = Y_i(x)
$$

- For individual `\(i\)`, who actually (in the real world) received exposure `\(x\)`, their observed outcome is the same as in the hypothetical world that this individual received the same exposure `\(x\)`. 


---
class: middle 

## Assuption No 3: &lt;br&gt;**Conditional Exchangeability**

- This means we are so *arrogant* and 100% sure that there is **no other unmeasured confounding**.


`$$Y(x)\perp \!\!\! \perp X| \textbf{C}, \forall x$$`

- `\(\perp \!\!\! \perp\)` means conditional independence; 
    - `\(A\perp \!\!\! \perp B | C\)` means "A is conditionally independent of B given C"
    
- `\(\forall\)` means "for all", here means `\(x = 0, 1\)`


???

Conditional on `\(\mathbf{C}\)`, the actual exposure level `\(X\)` is independent of the level of the potential outcomes.


---
class: middle

## Identification (1): 

Suppose we are interested in a conditional causal mean difference. 

`$$E\{Y(1) - Y(0) | \mathbf{C} = \mathbf{c}\}$$`

Given `\(\mathbf{C}\)`, where `\(\mathbf{C}\)` also is a set of covariates given which we believe **conditional exchangaeability** to be plausible -- no other unmeasured confoundings.

---
class: middle

## Identification (2): 


`$$\begin{aligned}E\{Y(1) - Y(0) | \mathbf{C} = \mathbf{c}\} &amp; = E\{Y(1)| \mathbf{C} = \mathbf{c}\} \\
&amp;\;\;\;\;\;- E\{Y(0)| \mathbf{C} = \mathbf{c}\} \\
&amp; =  E\{Y(1)| \color{red}{X = 1}, \mathbf{C} = \mathbf{c}\} \\
&amp;\;\;\;\;\;- E\{Y(0)| \color{red}{X = 0}, \mathbf{C} = \mathbf{c}\}\\
&amp; (\text{conditional exchangeability}) \\ 
&amp; =  E\{\color{red}{Y}| X = 1, \mathbf{C} = \mathbf{c}\} \\
&amp;\;\;\;\;\;- E\{\color{red}{Y}| X = 0, \mathbf{C} = \mathbf{c}\} \\
&amp; (\text{by consistency}) \\ 
\end{aligned}$$`

???

These steps are extremely important, 
under the assumptions of conditional exchangeability, consistency, we have rewritten our causal estimand -- unobservable potential outcomes -- into the observed data.

---
class: middle

## Assumptions linked between &lt;br&gt; causal estimand and observed data

These steps are extremely important, 
under the assumptions of conditional exchangeability, consistency, we have rewritten our causal estimand 

-- unobservable potential outcomes -- 

into the observed data.


---
class: middle 

## Estimation using linear regression

Suppose

`$$E\{Y|x = 1, \mathbf{C} = \mathbf{c}\} - E\{Y|x = 0, \mathbf{C} = \mathbf{c}\}$$`

is the same for every `\(\mathbf{c}\)` (covariate), then if we fit a linear regression model:

`$$E(Y|X=x, \mathbf{C} = \mathbf{c}) = \alpha + \color{red}{\beta}x + \gamma^T\mathbf{c}$$`

--
then the coefficient `\(\color{red}{\beta}\)` of `\(X\)` can be interpreted as the conditional causal mean difference, as long as the model is correctly specified. 


---
class: middle 

### Example: &lt;br&gt; maternal smoking and birth weight (1)

- Data is from Cattaneo &lt;sup&gt;1&lt;/sup&gt; on singleton babies born in Pennsylvania between 1989 and 1991.

- Outcome: birth weight, in grams

- Exposure: whether or not mothers smoked during the pregnancy

- n = 4642






.footnote[
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;font face="sans-serif"&gt;&lt;b&gt;&lt;br&gt;
[1]
 Cattaneo, M. D.

 Efficient semiparametric estimation of multi-valued treatment effects under ignorability 

 &lt;em&gt;Journal of Econometrics, &lt;/em&gt;



 &lt;em&gt;Elsevier, &lt;/em&gt;
&lt;b&gt;2010&lt;/b&gt;&lt;i&gt;, 155&lt;/i&gt;, 138-154 


&lt;p&gt;&lt;/p&gt;&lt;/font&gt;&lt;/body&gt;&lt;/html&gt;
]


---
class: middle
### Example: &lt;br&gt; maternal smoking and birth weight (2)

We think there are only 3 confounders:

- maternal age, 
- whether the baby is the first child,
- first clinical visit at which trimester. 

---
class: middle

### One possible linear regression model is:

.small[

```r
cattaneo2 &lt;- haven::read_dta("data/cattaneo2.dta")
Cat_mod &lt;- lm(bweight ~ as.factor(mbsmoke) + mage + 
                as.factor(fbaby) + as.factor(prenatal), 
              data = cattaneo2)
broom::tidy(Cat_mod, conf.int = TRUE) %&gt;% 
  knitr::kable(.)
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; term &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; estimate &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; std.error &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; statistic &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; p.value &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; conf.low &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; conf.high &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; (Intercept) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2735.8442 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 78.2260 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 34.9736 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2582.4841 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2889.2043 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; as.factor(mbsmoke)1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -252.2599 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 21.5677 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -11.6962 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -294.5428 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -209.9770 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; mage &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5.2681 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.6146 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3.2627 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00111 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.1027 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 8.4336 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; as.factor(fbaby)1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -59.9184 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 17.7004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -3.3851 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00072 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -94.6196 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -25.2172 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; as.factor(prenatal)1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 578.8464 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 68.5078 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 8.4494 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 444.5386 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 713.1542 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; as.factor(prenatal)2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 534.2280 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 70.6032 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7.5666 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 395.8122 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 672.6439 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; as.factor(prenatal)3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 458.5222 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 80.9992 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5.6608 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 299.7252 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 617.3191 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

---
class: middle
### Example: &lt;br&gt; maternal smoking and birth weight (3)

- Under assumptions of No Interference (NI),  Consistency (C), Conditional Exchangeability (CE) &lt;br&gt; and, **the model is correctly specified** 

- The estimate `\(\beta = -252.2599\)` can be given a **causal intepretation**: the expected difference in birth weight, conditional on three confounders, comparing a hypothetical situation in which: &lt;br&gt; &lt;br&gt; **all mothers smoke** versus a different hypothetical situation in which **no mothers smoke**


???

Under the assumptions, for a mother of a given age, first baby status, and timing of first clinical visit, we expect that the baby would be on average 252.3 grams lighter if the mother were hypothetically forced/randomised to smoking, versus if she were hypothetically prevented from smoking. 

---
class: middle

Under the assumptions, for a mother of a given age, first baby status, and timing of first clinical visit, we expect that the baby would be on average 252.3 grams lighter if the mother were **hypothetically forced/randomised to smoking**, versus if she were **hypothetically prevented from smoking**. 


---
class: middle

## Propensity score analysis (PSA)


- PSA make assumptions under the framework of causal inference: &lt;br&gt;No Interference (NI),  Consistency (C), Conditional Exchangeability (CE) 

--
- Plus, the (unknown) propensity score is appropriately modelled using the data.


--
- Instead of modelling `\(E(Y|X, \mathbf{C})\)`, we specify the form of `\(E(X| \mathbf{C})\)`


---
class: middle 

## Propensity score (1)

- The propensity score `\(p(\mathbf{C})\)`, is the conditional probability that `\(X = 1\)` given `\(\mathbf{C}\)`

$$
p(\mathbf{C}) = p(X = 1 | \mathbf{C})
$$

- A **scalar**, irrespective of the dimension of `\(\mathbf{C}\)`


- Rosenbaum and Rubin &lt;sup&gt;1&lt;/sup&gt; showed that if conditional exchangeability holds given `\(\mathbf{C}\)`, then it also holds given `\(p(\mathbf{C})\)`:

`$$Y(x)\perp \!\!\! \perp X| \textbf{C}, \forall x
\Rightarrow Y(x)\perp \!\!\! \perp X| \color{red}{p(\textbf{C})}, \forall x$$`


.tiny[
[1] &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;font face="sans-serif"&gt; Rosenbaum, P. R. &amp;amp; Rubin, D. B. The central role of the propensity score in observational studies for causal effects
 &lt;em&gt;Biometrika, &lt;/em&gt;
 &lt;em&gt;Oxford University Press, &lt;/em&gt;
&lt;b&gt;1983&lt;/b&gt;&lt;i&gt;, 70&lt;/i&gt;, 41-55 


&lt;p&gt;&lt;/p&gt;&lt;/font&gt;&lt;/body&gt;&lt;/html&gt;
]


---
class: middle

## Propensity score (2)

- In practice,  `\(p(\mathbf{C})\)` must be estimated by fiting a logistic regression of `\(X\)` on `\(\mathbf{C}\)`; 

- The **predicted values** from the logistic model are the individual propensity scores. 

- The validity of methods based on propensity scores relies on **correctly modelling** `\(E(X| \mathbf{C})\)`


---
class: middle

## Propensity score (3)

- If an exposed and unexposed person have the same value of `\(p(\mathbf{C})\)`, say 0.25, it means they were equally likely to have received the exposure. 

- This is **similar as** in a randomised trial, an exposed and unexposed subject with the same `\(p(\mathbf{C})\)` are exchangeable. Unless: 

  - Important confounders were not included in `\(p(\mathbf{C})\)`; 
  - `\(p(\mathbf{C})\)` was incorrectly modelled. 


---
class: middle

## Example: RFA dataset (1)

--
- 3351 patients with metastatic lung cancer were given either standard surgery (n = 1848) or radiofrequency ablation (RFA) (n = 1703) to remove metastatic lung cancer nodules. 

--
- 3-year progression-free survival is higher (79.2% versus 67.9%) for those who received RFA. 

--
- But confounding is a concern: larger modules cannot be removed by RFA, so at least some of the apparent protective effect of RFA is likely due to RFA given to patients **with already better prognosis**.


---
class: middle

## Example: RFA dataset (2)

- Potential confounders: age, gender, hospital (1,2,3,4), smoking (non, ex, current), nodules numbers, no. other metastatic sites, duration of disease, diameter of largest module, location of primary cancer (bladder, breast, bowel, gullet, kidney, skin, stomach....), modules can be reached easily (easy, moderate, difficult) 

---
class: middle

## Example: RFA dataset (3)

- Propensity score model: 


.small[
$$
`\begin{aligned}
\text{logit}\{ \text{Pr(RFA}|\mathbf{C} )\}  = &amp; \beta_0 + \beta_1\text{age} + \beta_2 \text{gender}+ \beta_3I(\text{hospital = 2}) \\
&amp; +\beta_4I(\text{hospital =3}) + \beta_5I(\text{hospital = 4}) \\
&amp; + \beta_6I(\text{smoke = 2} ) + \beta_7I(\text{smoke = 3}) + \beta_8\text{nodules}\\
&amp;  + \beta_9\text{mets} + \beta_{10}\text{duration}+ \cdots  + \beta_{20}I(\text{primary = 9})\\
&amp;  + \beta_{21}I(\text{position = 2}) + \beta_{22}I(\text{position = 3})
\end{aligned}`
$$
]

- `\(p(\mathbf{C})\)` is estimated from this `\(\uparrow\)` model for every patient.


---
class: middle

### The PS model estimates: 


.med[
&lt;div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:400px; overflow-x: scroll; width:780px; "&gt;&lt;table class="table table-striped" style="margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;"&gt; term &lt;/th&gt;
   &lt;th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;"&gt; estimate &lt;/th&gt;
   &lt;th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;"&gt; std.error &lt;/th&gt;
   &lt;th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;"&gt; statistic &lt;/th&gt;
   &lt;th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;"&gt; p.value &lt;/th&gt;
   &lt;th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;"&gt; conf.low &lt;/th&gt;
   &lt;th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;"&gt; conf.high &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; (Intercept) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.95799 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.61771 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.78866 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.74981 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.17252 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; age &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.00044 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00993 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.04434 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.96463 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.01993 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.01902 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; gender1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.10435 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.15103 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.69093 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.48961 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.19160 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.40063 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; smoke1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.11862 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.15107 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.78518 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.43235 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.17753 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.41508 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; smoke2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.09342 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.10381 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.89997 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.36814 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.11000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.29704 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; hospital2 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -0.23564 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.14244 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -1.65436 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.09805 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -0.51512 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.04341 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; hospital3 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.30046 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.13851 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 2.16923 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.03007 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.02923 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.57236 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; hospital4 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -0.11175 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.19237 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -0.58092 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.56129 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -0.48898 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.26526 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; nodules &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.02988 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.01821 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -1.64105 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.10079 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.06594 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00550 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; mets &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.06514 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.04672 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.39423 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.16325 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.02641 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.15680 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; duration &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00261 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.00489 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.53354 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.59366 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.00698 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.01218 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; maxdia &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -2.26045 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.08774 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -25.76373 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -2.43490 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; -2.09089 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; primary2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.09928 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.29102 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.34114 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.73300 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.46959 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.67330 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; primary3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.14593 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.29460 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.49536 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.62035 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.42937 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.72768 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; primary4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.00213 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.38021 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.00559 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.99554 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.74649 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.74543 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; primary5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.22135 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.37933 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.58353 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.55953 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.96499 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.52355 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; primary6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.04505 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.34609 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.13016 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.89644 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.63128 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.72712 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; primary7 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 1.57439 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.64793 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 2.42989 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.01510 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.36040 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 2.92946 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; primary8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.21261 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.38273 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.55552 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.57854 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.53651 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.96525 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; primary9 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.33223 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.40566 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.81899 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.41279 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.46107 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.13046 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; position2 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.94096 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.10080 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 9.33491 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.74445 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 1.13969 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; position3 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 1.22135 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.11678 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 10.45840 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.00000 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 0.99365 &lt;/td&gt;
   &lt;td style="text-align:right;font-weight: bold;color: white !important;background-color: #D7261E !important;"&gt; 1.45155 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;&lt;/div&gt;
]


???

As expected, hospital, diameter of largest nodule, and position of the nodule are strong predictors of the treatment. 


---
class: inverse
background-image: url("./fig/scoreoverlap.png")
background-position: 50% 50%
background-size: contain




---
class: middle

## How do we use the propensity scores?

- If controlling `\(\mathbf{C}\)` is deemed sufficient, then controlling for `\(p(\mathbf{C})\)` is also sufficient. 

- `\(p(\mathbf{C})\)` is a scalar, so controlling for it is much easier than controlling for `\(\mathbf{C}\)`.

- Ways of using the propensity scores include: 
  - stratification;
  - adjustment;
  - matching;
  - re-weighting (inverse-weighting).


---
class: middle

### Stratification (1)

If we subclassifying the patients according to quartiles of `\(\hat{p}(\mathbf{C})\)`: 

.small[
| PS subclasses | Treatment | N of patients | Prob of death or &lt;br&gt;disease progression (%) | Risk difference (%) |
|:-------------:|:---------:|:-------------:|:--------------------------------------------:|:-------------------:|
|       1       |  Standard |      788      |                     37.9                     |         13.1        |
|               |    RFA    |      100      |                     51.0                     |                     |
|       2       |  Standard |      547      |                     30.7                     |         6.0         |
|               |    RFA    |      341      |                     36.7                     |                     |
|       3       |  Standard |      344      |                     25.6                     |         -4.8        |
|               |    RFA    |      544      |                     20.8                     |                     |
|       4       |  Standard |      169      |                     22.5                     |        -13.4        |
|               |    RFA    |      718      |                      9.1                     |                     |
]

---
class: middle

### Stratification (2)

- Our suspicion of confounding is seen clearly, the probability of death or disease progression is higher in the lower categories of the propensity score. 

- There is effect modification by the propensity score. RFA is better than standard surgery only in the upper two propensity score subclasses. 

- The doctors are making choices for their patients. RFA are more likely to be given to patients who can benefit from the treatment.


---
class: middle

### Estimating  `\(E\{Y(1) - Y(0)\}\)` &lt;br&gt; (average causal/treatment effect, ACE)


The ACE can be estimated as the simple (unweighted) average of the 4 stratum-specific effects:


$$
\widehat{\text{ACE}} = \frac{13.1 + 6.0 - 4.8 - 13.4}{4} = 0.2 \%
$$

---
class: middle

### Estimating `\(E\{Y(1) - Y(0) | X = 1\}\)` &lt;br&gt; (average treatment effect on the **treated**, ATT)


.between[
| PS subclasses | Treatment | N of patients | Prob of death or &lt;br&gt;disease progression (%) | Risk difference (%) |
|:-------------:|:---------:|:-------------:|:--------------------------------------------:|:-------------------:|
|       1       |  Standard |      788      |                     37.9                     |         13.1        |
|               |    RFA    |      **100**      |                     51.0                     |                     |
|       2       |  Standard |      547      |                     30.7                     |         6.0         |
|               |    RFA    |      **341**      |                     36.7                     |                     |
|       3       |  Standard |      344      |                     25.6                     |         -4.8        |
|               |    RFA    |      **544**      |                     20.8                     |                     |
|       4       |  Standard |      169      |                     22.5                     |        -13.4        |
|               |    RFA    |      **718**      |                      9.1                     |                     |
]

.small[
$$
\widehat{\text{ATT}} = \frac{-13.1 \times 100 + 6.0 \times 341 - 4.8 \times 544 - 13.4\times718}{100 + 341 + 544 + 718} = -5.2\%
$$
]

???

The results shows that RFA is beneficial to those who tend to get the treatment (consistent with the effect modification)


---
class: middle, center

# Hold on,

--
# Before we move on to other methods of using the PS. 

--
# We should bear in mind that we assumed the model for PS generation was correctly chosen. 

---
class: middle, center

## Other than that, 

--
## we also assumed that **all confounders** were included 

--
## plus, some people may believe including non-confounders but predictive of the X is beneficial for precision. 


---
class: middle


## Finally,

--
## How do we know if there is any other un-observed confounders?




---
class: middle
## Check for un-observed confounders (1)

- Researchers should routinely test for residual confounding or **endogeneity** (even after PS matching). &lt;br&gt;
This can be done using residuals of the PS model.

.med[
$$
`\begin{aligned}
\text{logit}\{ \text{Pr(RFA}|\mathbf{C}) \} &amp; =  \beta_0 + \beta_1\text{age} + \dots + \color{red}{\epsilon}
\end{aligned}`
$$
]


---
class: middle
## Check for un-observed confounders (2)

- If the outcome equation is as follows (linear model here for illustration), where `\(\nu\)` is the residuals.

.med[
$$
`\begin{aligned}
Y &amp; =  \alpha_0 + \alpha_1\text{age} + \dots + \color{red}{\nu}
\end{aligned}`
$$
]

- The following assumption should hold 

`$$\small{cor(\text{logit}\{ \text{Pr(RFA}|\mathbf{C}) \},\nu)=cor(\epsilon,\nu)=0}$$`


---

class: middle

## Hausman test (Endogeneity test)

- Null hypothesis is as follows: 

`$$\small{cor(\text{logit}\{ \text{Pr(RFA}|\mathbf{C} )\},\nu)=cor(\epsilon,\nu)=0}$$`

- Equivalent to test `\(\color{blue}{\delta}=0\)` in the following equation (using usual tests):

$$
`\begin{aligned}
Y =  \alpha_0 + \alpha_1\text{age} + ...+\color{blue}{\delta} \epsilon +\color{red}{\nu}
\end{aligned}`
$$


---
class: middle

## Alternative #1: (1)&lt;br&gt; Differences-in-Differences methods

Other than fitting models to calculate propensity scores, we may do the following:
&lt;!-- to propensity score based methods --&gt;

- Non-parametric alternative

- Require 2 periods in a same patient: 

1.  A baseline period in the same period when neither the intervention nor the comparator are observed
2.  A period the intervention or the comparator is attributed


---
class: middle

## Alternative #1: (2)

- The outcome equations for the respective periods are:


$$
`\begin{aligned}
Y_{i1} &amp; =  B_0 + B_1 X_{i1}+\mathbf{B_2 \lambda_{i}} +\epsilon_{i1} \\
Y_{i2} &amp; = B_0 + B_1 X_{i2}+\mathbf{B_2 \lambda_{i}} + \color{red}{B_3 T_i}+\epsilon_{i2}
\end{aligned}`
$$


- The effect for each patient is estimated as follows:

`$$Y_{i2}-Y_{i1} = B_1(X_{i2}-X_{i1})+B_3T_i+(\epsilon_{i2}-\epsilon_{i1})$$`


---
class: middle

### Pros

- remove unobserved fixed effects

- instrumental variables are not required

- possibility to combine DID with PS matching (**Heckman et al.**)

### Cons

- DID estimator interpretation is not clear in the presence of within-treatment heterogeneity (differential effect in subgroups of non-observed characteristics)

---
class: middle

## Alternative #2: Endogenous switching regression (Econometric approach)


- Use in practice when heterogeneity is observed

- Compared to propensity score model, the selection process is modeled and counterfactuals are considered to estimate the effects

- ATE (average treatment effect), ATT, **ATU** (Average treatment effect on untreated population), heterogeneity for each outcome



---
class: middle

## Definitions of the different effects

- Average treatment among the untreated

.med[
$$
ATU: E(Y(1) - Y(0)|\mathbf{X,W=0})
$$
]

- Effect of heterogeneity in the treated

.med[
$$
BH1: E(Y(0)|\mathbf{X,W=1})-E(Y(0)|\mathbf{X,W=0})
$$
]

- Effect of heterogeneity in the untreated

.med[
$$
BH2: E(Y(1)|\mathbf{X,W=1})-E(Y(1)|\mathbf{X,W=0})
$$
]

---
class: middle

### General model framework (1)

- The selection process is based on the estimation of utility:

`\(A_i^{*}=Z_i\alpha+\eta_i\)` **(1)**, with `\(Z_i\)` as observed variables (at least one instrument is required)

.small[
$$
A_i=
`\begin{cases}
1 &amp; \text{ if } A_i^{*}&gt;0\\
0 &amp; \text{otherwise}
\end{cases}`
$$
]

---
class: middle

### General model framework (2)

- In a second step, a switching regression model **(2)** is estimated for each subpopulation `\(A_i\)`:


$$
`\begin{aligned}
Y_{1i} &amp; =  X_{1i}\beta_1+\epsilon_{1i} \\
Y_{0i} &amp; =  X_{0i}\beta_0+\epsilon_{0i}
\end{aligned}`
$$

- Correlations between residuals in **(1)** and **(2)** are nonzero (presence of heterogeneity).

$$
Cor(\eta,\epsilon) \neq 0
$$


---
class: middle

### Pros

- Assessment of ATU and BH effects: policy/intervention on untreated and heterogeneity might be important in decision-making

- Control for both the structural relationships of the covariates with outcomes, and the sample composition of both groups

### Cons

- Difficult to find a good instrument in practice (variable included in the selection process not related to the outcome directly)



---
class: middle, center 

# The end for the first day

## slide address: https://wangcc.me/PSA-CSS


---
class: middle, center, inverse

# Propensity Score Analysis (PSA) -- Day 2
### Chaochen Wang (CWAN) &lt;br&gt; Thomas Laurent (TLAU)

### 2020-2-14 (tentative) 16:00~17:00 @CSS


---
class: middle

# Recap

We discussed about:

- the causal inference framework under which that PSA was designed for; 

- the assumptions required when consider using the PSA;

    - No interference, Consistency, Conditional Exchangeability

- ATE calculated through a stratification procedure. 

---
class: middle

# Today 

We will try to cover: 

- Adjusting for PS in the model; 

- Matching participants by PS; 

- Inversely weighting the participants by their PS;

- Cautions and best guidelines to follow when reporting studies used PS. 

---
class: middle

## Regression Adjustment

- Another approach of using PS is to **adjust** for the propensity score in a regression model.

`$$E\{Y|X, p(\mathbf{C})\} = \alpha + \color{red}{\beta} X + \gamma p(\mathbf{C})$$`


- `\(\color{red}{\beta}\)` potentially has a **causal (conditional) interpretation**

    - because if conditional exchangeability holds given `\(\mathbf{C}\)` then it also holds given `\(p(\mathbf{C})\)`
    
- `\(\gamma\)` is now one-dimensional so, **finite sample bias** would no longer be a problem.


  
---
class: inverse
background-image: url("./fig/adjustment.png")
background-position: 50% 50%
background-size: contain


???

finite sample bias is no longer a concern for propensity score adjustment as the number of covariates increases. 


---
class: middle

## Matching on the estimated PS

Matching on the PS means we take one patient who recieved RFA and find one (or more than one) match for him/her *with replacement* from those who recieved standard surgery but with a similar value of PS.

- To estimate **average treatment effect in the treated (ATT)**;


- If we start matching with those who recieved standard surgery, this will be an estimate of the **average treatment effect in the untreated (ATU)**.


---
class: middle

## Matching methods

- nearest neightbour matching

- within calipers method (Mahalanobis metric matching)

- etc.

- Problem of **poor overlap (or lack of positivity)** is immediately flagged up when some individuals fail to be mached. 

---
class: middle

## Balance diagnostics after matching

- [Standardized mean difference (SMD)](https://cran.r-project.org/web/packages/tableone/vignettes/smd.html) is mostly used: 

`$$SMD = \frac{\bar{X_1} - \bar{X_2}}{\sqrt{(\hat{\sigma_1}^2 + \hat{\sigma_2}^2)/2}} &lt;0.1$$`

- For dichotomous variables and categorical variable, see reference &lt;sup&gt;1&lt;/sup&gt;: 

.between[
Yang DS, Dalton JE. A Unified Approach to Measuring the Effect Size Between Two Groups Using SAS. SAS Global Forum 2012. paper 335
]

---
class: middle

## Inverse probability weighting (1)

- The propensity scores we have calculated are the **conditional probabilities** - based on all of the confounders we have found and included - that the individuals will be exposed. 

- So there are some individuals, who, condition on their confounders, are more or less likely to be exposed. 

---
class: middle 

## Inverse probability weighting (2)

- If we found that someone in the study, condition on her/his all available confounders, was **unlikely** to be exposed to the intervention (treatment), `\(p(\mathbf{C})\)` is small.

--
- We may consider **upweight** him/her, so that (s)he represents him/her and also many other who may like him/her who were unlikely to be unexposed.

--
- Then we will have a re-weighted dataset in which `\(\mathbf{X}\)` (exposure), and `\(p(\mathbf{C})\)` are independent, but everything else is unchanged. 


---
class: middle 

## Simple example (1)

- Suppose the counterfactual data are:

|      Group     | A | A | A | B | B | B | D | D | D |
|:--------------:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| Response `\(Y(1)\)`: | 1 | 1 | 1 | 2 | 2 | 2 | 3 | 3 | 3 |
| Response `\(Y(0)\)`: | 0 | 0 | 0 | 1 | 1 | 1 | 2 | 2 | 2 |

- Even without fitting any model, we can tell that the average treatment effect (ATE) is 1. 

---
class: middle

## Simple example (2)

- However, we can only observe (in the real world under consistency):

|     Group    |  A |  A |  A |  B |  B |  B |  D |  D |  D |
|:------------:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|  Exposed `\(Y\)`:  |  1 |  1 | NA | NA |  2 | NA |  3 | NA | NA |
| Unexposed `\(Y\)`: | NA | NA |  0 |  1 | NA |  1 | NA |  2 |  2 |


- The estimated average treatment effect (ATE) is &lt;br&gt; 7/4 - 6/5 = 0.55, **(hugely biased)**


---
class: middle

## Weighting to reduce bias (IPTW)

- The probability of recieving treatment: 

  - 2/3 in group A; 
  - 1/3 in group B;
  - 1/3 in group D.

- Calculate weighted average &lt;br&gt; (by **1/{Probability of observed treament}**)


.small[
`$$\frac{(1 + 1) \times \frac{3}{2} + (2) \times \frac{3}{1} + (3) \times \frac{3}{1}}{\frac{3}{2} + \frac{3}{2} + \frac{3}{1} + \frac{3}{1}} \\ \;\;\;\;- \frac{(0) \times \frac{3}{1} + (1 + 1) \times \frac{3}{2} + (2 + 2) \times \frac{3}{2}}{\frac{3}{1} + \frac{3}{2}+ \frac{3}{2}+ \frac{3}{2}}= 2-1 = 1$$`
]

---
class: middle

## **I**nverse **P**robability of **T**reatment **W**eighting (IPTW)

- IPTW successfully removed the bias by creating a "fake" population where we 'observe' each subject at each exposure level.

- It can be proved that IPTW can provide consistent estimators. 

---
class: middle

## IPTW conditioning on binary confounder C (1)

.pull-left[
- Observed data: 

&lt;style type="text/css"&gt;
.tg  {border-collapse:collapse;border-spacing:0;border-width:1px;border-style:solid;border-color:#ccc;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#fff;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#f0f0f0;}
.tg .tg-p0ii{background-color:#f9f9f9;font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
.tg .tg-9d8n{font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
&lt;/style&gt;
&lt;table class="tg"&gt;
  &lt;tr&gt;
    &lt;th class="tg-9d8n"&gt;&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 1&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 0&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 1&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;180&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;200&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;600&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;200&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;20&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;200&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;200&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;600&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
]



.pull-right[
- Table of `\(\color{red}{P(X|C)}\)` 

&lt;style type="text/css"&gt;
.tg  {border-collapse:collapse;border-spacing:0;border-width:1px;border-style:solid;border-color:#ccc;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#fff;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#f0f0f0;}
.tg .tg-p0ii{background-color:#f9f9f9;font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
.tg .tg-9d8n{font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
&lt;/style&gt;
&lt;table class="tg"&gt;
  &lt;tr&gt;
    &lt;th class="tg-9d8n"&gt;&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 1&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 0&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 1&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;0.780&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;0.333&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;0.780&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;0.333&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;0.220&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;0.667&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;0.220&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;0.667&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

]

Where, `\(0.780 = (180 + 600)/(180 + 600 + 20 + 200)\)`


---
class: middle 
## IPTW conditioning on binary confounder C (2)

- Dividing each cell count by `\(\color{red}{P(X|C)}\)` 

&lt;style type="text/css"&gt;
.tg  {border-collapse:collapse;border-spacing:0;border-width:1px;border-style:solid;border-color:#ccc;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#fff;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#f0f0f0;}
.tg .tg-p0ii{background-color:#f9f9f9;font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
.tg .tg-9d8n{font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
&lt;/style&gt;
&lt;table class="tg"&gt;
  &lt;tr&gt;
    &lt;th class="tg-9d8n"&gt;&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 1&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 0&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 1&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;180/0.78 &lt;br&gt;= 231&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;200/0.333 &lt;br&gt;= 600&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;600/0.78 &lt;br&gt;= 769&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;200/0.333 &lt;br&gt;= 600&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;20/0.22 &lt;br&gt;= 91&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;200/0.667 &lt;br&gt;= 300&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;200/0.22 &lt;br&gt;= 909&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;600/0.667 &lt;br&gt;= 900&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

---
class: middle
## IPTW conditioning on binary confounder C (3)

- The impact of inverse weighting by `\(\color{red}{P(X|C)}\)` is to create a pseudo(fake)-population where we 'observe' each subject at each exposure level: 

&lt;style type="text/css"&gt;
.tg  {border-collapse:collapse;border-spacing:0;border-width:1px;border-style:solid;border-color:#ccc;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#fff;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#f0f0f0;}
.tg .tg-p0ii{background-color:#f9f9f9;font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
.tg .tg-390v{background-color:#f8ff00;font-size:22px;border-color:inherit;text-align:left;vertical-align:top}
.tg .tg-9d8n{font-size:22px;border-color:inherit;text-align:center;vertical-align:top}
.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
.tg .tg-ovs6{font-size:22px;background-color:#f8ff00;border-color:inherit;text-align:left;vertical-align:top}
&lt;/style&gt;
&lt;table class="tg"&gt;
  &lt;tr&gt;
    &lt;th class="tg-9d8n"&gt;&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 1&lt;/th&gt;
    &lt;th class="tg-9d8n" colspan="2"&gt;Y = 0&lt;/th&gt;
    &lt;th class="tg-0pky"&gt;&lt;/th&gt;
    &lt;th class="tg-0pky"&gt;&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;C = 0&lt;/td&gt;
    &lt;td class="tg-390v"&gt;C = 1&lt;/td&gt;
    &lt;td class="tg-ovs6"&gt;C = 0&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 1&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;231&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;600&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;769&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;600&lt;/td&gt;
    &lt;td class="tg-390v"&gt;1000&lt;/td&gt;
    &lt;td class="tg-ovs6"&gt;1200&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="tg-9d8n"&gt;X = 0&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;91&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;300&lt;/td&gt;
    &lt;td class="tg-p0ii"&gt;909&lt;/td&gt;
    &lt;td class="tg-9d8n"&gt;900&lt;/td&gt;
    &lt;td class="tg-390v"&gt;1000&lt;/td&gt;
    &lt;td class="tg-ovs6"&gt;1200&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

---
class: middle

# PS matching and IPTW example - data

- Right heart catheterization data

- We can download the data from : [http://biostat.mc.vanderbilt.edu/wiki/Main/DataSets](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv)

- Data are from ICU patients in 5 hospitals

- **Treatment**: right heart catheterization (rhc) or not

- **Outcome**: death

- **Confounders**: demographics, insurance, disease diagnoses, etc.


&lt;!-- (https://www.coursera.org/lecture/crash-course-in-causality/data-example-in-r-Ie48W) --&gt;


---
class: middle

## First steps &lt;br&gt;- load packages, read in data


```r
# load packages
library(tableone)
library(Matching)

# Read in data
load(url("http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.sav"))
```


---
class: middle

## Second steps - create data set

.med[

```r
# create a data set with just these variables, for simplicity
library(tidyverse) # load this package if you have not

dat &lt;- rhc %&gt;% 
  dplyr::select(cat1, sex, death, age, swang1, meanbp1) %&gt;% 
  mutate(ARF = as.numeric(cat1 == "ARF"), 
         CHF = as.numeric(cat1 == "CHF"), 
         Cirr = as.numeric(cat1 == "Cirrhosis"), 
         colcan = as.numeric(cat1 == "Colon Cancer"), 
         Coma = as.numeric(cat1 == "Coma"), 
         COPD = as.numeric(cat1 == "COPD"), 
         lungcan = as.numeric(cat1 == "Lung Cancer"), 
         MOSF = as.numeric(cat1 == "MOSF w/Malignancy"), 
         sepsis = as.numeric(cat1 == "MOSF w/Sepsis"), 
         female = as.numeric(sex == "Female"), 
         died = as.numeric(death == "Yes"), 
         treatment = as.numeric(swang1 == "RHC"), 
         age = as.numeric(age), 
         meanbp1 = as.numeric(meanbp1))
```
]


---
class: middle 

## Continued


```r
# Covariates will be used: 
xvars &lt;- c("ARF", "CHF", "Cirr", "colcan", "Coma", "lungcan", "MOSF", 
           "sepsis", "age", "female", "meanbp1")
```

### Create a Table 1


```r
# Look at a table 1

table1 &lt;- CreateTableOne(vars = xvars, strata = "treatment", 
                         data = dat, test = FALSE)

# include standardized mean difference (SMD)
print(table1, smd = TRUE)
```


---
class: middle 

# Reading list

1. 5 misunderstandings about propensity score &lt;br&gt; [PSに関する5つの誤解](https://healthpolicyhealthecon.com/2015/05/07/propensity-score-2/)

2. Causal inference in Statistics,  [統計学における因果推論（ルービンの因果モデル）](https://healthpolicyhealthecon.com/2014/11/30/rubin_causal_model/)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"highlightSpans": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function(time) {
  var d2 = function(number) {
    return ('0' + number).slice(-2); // left-pad 0 to minutes/seconds
  },

  time_format = function(total) {
    var secs = Math.abs(total) / 1000;
    var h = Math.floor(secs / 3600);
    var m = Math.floor(secs % 3600 / 60);
    var s = Math.round(secs % 60);
    var res = d2(m) + ':' + d2(s);
    if (h > 0) res = h + ':' + res;
    return res;  // [hh:]mm:ss
  },

  slide_number_div = function(i) {
    return document.getElementsByClassName('remark-slide-number').item(i);
  },

  current_page_number = function(i) {
    return slide_number_div(i).firstChild.textContent;  // text "i / N"
  };

  var timer = document.createElement('span'); timer.id = 'slide-time-left';
  var time_left = time, k = slideshow.getCurrentSlideIndex(),
      last_page_number = current_page_number(k);

  setInterval(function() {
    time_left = time_left - 1000;
    timer.innerHTML = ' ' + time_format(time_left);
    if (time_left < 0) timer.style.color = 'red';
  }, 1000);

  slide_number_div(k).appendChild(timer);

  slideshow.on('showSlide', function(slide) {
    var i = slide.getSlideIndex(), n = current_page_number(i);
    // reset timer when a new slide is shown and the page number is changed
    if (last_page_number !== n) {
      time_left = time; last_page_number = n;
      timer.innerHTML = ' ' + time_format(time); timer.style.color = null;
    }
    slide_number_div(i).appendChild(timer);
  });
})(60000);
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
